<!-- admin_course_materials.html -->
{% extends "admin/base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/materials.css') }}">
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="fas fa-book-reader"></i> Manage Course Materials</h1>
</div>

<div class="filter-bar">
    <form class="filter-form" method="GET" action="{{ url_for('admin_materials') }}">
        <label for="course_id">Choose a course:</label>
        <select name="course_id" id="course_id" onchange="this.form.submit()">
            <option value="">Select Course</option>
            {% for course in all_courses %}
            <option value="{{ course._id }}" {% if selected_course == course._id %}selected{% endif %}>{{ course._id }}</option>
            {% endfor %}
        </select>
    </form>
</div>

{% if course_materials %}
<div class="course-materials">
    {% for lesson_key, lesson in course_materials.materials.items() %}
    <div class="lesson-block">
        <h3 class="lesson-title toggle-btn" onclick="toggleLesson(this)">
            <i class="fas fa-chalkboard-teacher"></i> {{ lesson.tittle }} ({{ lesson_key }})
            <i class="fas fa-chevron-down lesson-toggle-icon"></i>
        </h3>

        <div class="lesson-content">
            <h4>üìë Presentations</h4>
            <ul>
                {% for url in lesson.presentations %}
                <li>
                    {{ loop.index }}.
                    <a href="{{ url }}" target="_blank">View</a>
                </li>
                {% endfor %}
            </ul>

            <h4>üíª Code Notebooks</h4>
            <ul>
                {% for url in lesson.code %}
                <li>
                    {{ loop.index }}.
                    <a href="{{ url }}" target="_blank">View</a>
                </li>
                {% endfor %}
            </ul>

            <h4>üìÅ Other Materials</h4>
            <ul>
                {% for url in lesson.other %}
                <li>
                    {{ loop.index }}.
                    <a href="{{ url }}" target="_blank">View</a>
                </li>
                {% endfor %}
            </ul>

            <div class="lesson-actions">
                <button class="btn btn-edit" onclick="editLesson('{{ lesson_key }}')">
                    <i class="fas fa-edit"></i> Edit Lesson
                </button>
                <button class="btn btn-danger" onclick="deleteLesson('{{ lesson_key }}')">
                    <i class="fas fa-trash"></i> Delete Lesson
                </button>
            </div>
        </div>
    </div>
    {% endfor %}

    <button class="btn btn-admin" onclick="document.getElementById('add-lesson-modal').style.display='block'">
        <i class="fas fa-plus"></i> Add New Lesson
    </button>
</div>
{% endif %}

<!-- Add Lesson Modal -->
<div id="add-lesson-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
        <h2>Add New Lesson</h2>
        <form method="POST">
            <input type="hidden" name="course_id" value="{{ selected_course }}">
            <div class="form-group">
                <label>Lesson Title:</label>
                <input type="text" name="title" required>
            </div>
            <div class="form-group">
                <label>Lesson Key (e.g. lesson 3):</label>
                <input type="text" name="lesson_key" required>
            </div>
            <div class="form-group">
                <label>Presentation URLs (comma-separated):</label>
                <textarea name="presentations"></textarea>
            </div>
            <div class="form-group">
                <label>Code URLs (comma-separated):</label>
                <textarea name="code"></textarea>
            </div>
            <div class="form-group">
                <label>Other URLs (comma-separated):</label>
                <textarea name="other"></textarea>
            </div>
            <button type="submit" class="btn btn-save">Add Lesson</button>
        </form>
    </div>
</div>

<script>
    function toggleLesson(el) {
        const content = el.nextElementSibling;
        const icon = el.querySelector('.lesson-toggle-icon');
        if (content.style.display === 'none' || !content.style.display) {
            content.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            content.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.lesson-content').forEach(el => el.style.display = 'none');
    });

    function editLesson(lessonKey) {
        alert("Trigger edit for " + lessonKey);
        // Integrate with actual modal or navigation
    }
    function deleteLesson(lessonKey) {
        if (confirm("Are you sure you want to delete " + lessonKey + "?")) {
            // POST request to delete endpoint
        }
    }
</script>
{% endblock %}
